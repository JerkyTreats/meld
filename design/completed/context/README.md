# Context, Agent, Provider Management

## Overview

This directory contains specifications for Context, Agent, and Provider management  for the Merkle filesystem state management tool. The context system provides a convenient interface for generating, retrieving, and managing context frames associated with filesystem nodes, while the agent system supports user-customized agents with markdown-based prompts stored in XDG directories.

The suite is centered around `merkle context`, `merkle agent`, and `merkle provider` commands.

---

## CLI Commands

### Context Commands

**Context Generation**:
- `merkle context generate --path <path> [options]` - Generate context frame for a node
- `merkle context generate --node <node_id> [options]` - Generate context frame by NodeID
  - `--agent <agent_id>` - Agent to use for generation
  - `--frame-type <type>` - Frame type (defaults to `context-<agent_id>`)
  - `--force` - Generate even if head frame exists
  - `--sync` - Wait for completion (default)
  - `--async` - Enqueue and return immediately

**Context Retrieval**:
- `merkle context get --path <path> [options]` - Get context frames for a node
- `merkle context get --node <node_id> [options]` - Get context frames by NodeID
  - `--agent <agent_id>` - Filter by agent
  - `--frame-type <type>` - Filter by frame type
  - `--max-frames <n>` - Maximum frames to return (default: 10)
  - `--ordering <recency|deterministic>` - Ordering policy (default: recency)
  - `--combine` - Concatenate frame contents
  - `--separator <text>` - Separator for combined output
  - `--format <text|json>` - Output format
  - `--include-metadata` - Include metadata in output

### Agent Management

- `merkle agent list` - List all agents
- `merkle agent show <agent_id>` - Show agent details
- `merkle agent validate <agent_id>` - Validate configuration
- `merkle agent create <agent_id>` - Create new agent
- `merkle agent edit <agent_id>` - Edit agent config

### Provider Management

- `merkle provider list` - List all providers
- `merkle provider show <provider_name>` - Show provider details
- `merkle provider validate <provider_name>` - Validate configuration
- `merkle provider test <provider_name>` - Test provider connectivity
- `merkle provider create <provider_name>` - Create new provider
- `merkle provider edit <provider_name>` - Edit provider config

---

## Key Concepts

### Agents

Agents are **provider-agnostic** configurations that define:
- System prompts (stored as markdown files)
- User prompt templates
- Role and behavior definition
- Output expectations

Agents are stored in `$XDG_CONFIG_HOME/merkle/agents/` and are available across all workspaces. Providers are selected at runtime, not in agent configuration.

### Providers

Providers handle LLM API configuration:
- API endpoints and authentication
- Model selection
- Default completion parameters

Providers are stored in `$XDG_CONFIG_HOME/merkle/providers/` and are managed independently from agents.

### Context Frames

Immutable content associated with filesystem nodes, stored append-only. Each frame has:
- Frame ID (deterministic hash)
- Frame type (defaults to `context-<agent_id>`)
- Content (generated by LLM)
- Metadata (agent, timestamp, etc.)

---

## Terminology

- **Context Frame**: Immutable content associated with a node; stored append-only.
- **NodeID**: Deterministic 32-byte hash identifying a filesystem node.
- **Frame Type**: Logical label for a frame; defaults to `context-<agent_id>`.
- **Agent**: Identity with prompts and behavior used for LLM generation (provider-agnostic).
- **Head**: The latest frame per node and frame type.
- **Provider**: LLM service configuration (OpenAI, Anthropic, Ollama, etc.) selected at runtime.

---

## Path Resolution

Path-based commands:
1. Canonicalize paths relative to the configured workspace root
2. Look up the NodeID in the NodeRecord store
3. Fail with `PathNotInTree` if the path is not present

**Error guidance**: Suggest running `merkle scan` or starting `merkle watch` if the tree is outdated.

---

## Related Documentation

### Implementation Plan

- **[PLAN.md](PLAN.md)** - Phased implementation plan for the context and agent management refactor

### Command Specifications

- **[context_generate_command.md](context_generate_command.md)** - Detailed specification for `merkle context generate`
- **[context_get_command.md](context_get_command.md)** - Detailed specification for `merkle context get`

### Agent Management

- **[agents/agent_management_requirements.md](agents/agent_management_requirements.md)** - Agent management requirements and design
- **[agents/agent_cli_spec.md](agents/agent_cli_spec.md)** - Agent CLI command specifications

### Provider Management

- **[provider/provider_agent_separation.md](provider/provider_agent_separation.md)** - Provider-Agent separation design
- **[provider/provider_management_requirements.md](provider/provider_management_requirements.md)** - Provider management requirements
- **[provider/provider_cli_spec.md](provider/provider_cli_spec.md)** - Provider CLI command specifications

### Core APIs

- **[../workflow/phase2_apis.md](../workflow/phase2_apis.md)** - Core Context API specifications
- **[../workflow/context_api_ergonomics_spec.md](../workflow/context_api_ergonomics_spec.md)** - API ergonomics and convenience methods

### System Architecture

- **[../workflow/phase2_spec.md](../workflow/phase2_spec.md)** - Phase 2 overall specification
- **[../workflow/phase2_architecture.md](../workflow/phase2_architecture.md)** - Architecture overview
- **[../workflow/phase2_components.md](../workflow/phase2_components.md)** - Component specifications
- **[../workflow/frame_generation_queue_spec.md](../workflow/frame_generation_queue_spec.md)** - Frame generation queue
- **[../workflow/phase2_model_providers.md](../workflow/phase2_model_providers.md)** - Model provider integration
- **[../workflow/head_index_persistence_spec.md](../workflow/head_index_persistence_spec.md)** - Head index persistence

---

## Architecture

The context management system builds on the core Context API:

1. **Path Resolution**: Converts file paths to NodeIDs using the NodeRecord store
2. **Agent Resolution**: Selects appropriate agent based on configuration and flags
3. **Frame Generation**: All generation requests go through FrameGenerationQueue (the only path to providers)
   - Sync mode: `ContextApiAdapter::generate_frame()` → `queue.enqueue_and_wait()`
   - Async mode: Direct `queue.enqueue()` call
   - Queue workers call providers directly in `process_request()`
4. **Frame Retrieval**: Queries frames using ContextView policies

All operations maintain the append-only storage model and preserve historical frames. Context frames are immutable and cannot be deleted, ensuring a complete audit trail.

---

[← Back to Phase 2 Spec](../workflow/phase2_spec.md)
